关于 DSL
===

## 为什么要开发一种DSL
1. 我们需要状态机而又"讨厌"它.  
    每个工作流都是一个有限状态机. 按照传统方法, 编写一个状态机需要先定义N个状态和状态间的流转规则(state transition rule), 然后我们可以定义进入某状态时应该执行的操作. 和数学模型不同, 软件工程中的状态机往往是和行为挂钩的, 我们不会定义无行为的状态. 既然无此, 我们为什么还要绞尽脑汁去想"它应该处于什么样的`状态`?"(这也是为什么我们毕业后都把状态机抛之脑后的原因, 每定义一个`状态`都会让人陷入无尽的"哲学思考"😂), 而不是直接定义其行为?
2. 我们把`行为`串联起来再抽象.
    (...)
3. 我们必须给你(开发者)做一些限制.
    (...)
4. 我们为什么不用现成的好东西, 如 `json`, `xml`, `uml`.  
    第一是麻烦, json / xml / uml 需要定义各种专属关键字, 使用者也需要逐一了解, 学习成本和熟悉一门新DSL语言一样高.
    第二是不直观, 各种关键字混在流程文档里需要认真读才能明白, 行为的走向也不明确(不如 -> 或 |>, ||> 这样的符号), 组合行为, 嵌套逻辑也都依赖关键字.
    第三是不利于行为复用, 如果一个`行为`是一个json结构的东西 (比如: `{"actionName": "Approval", ActivateMethod: "MANUAL", "props": {"roles": ["manager"]}}` ), 当它在一个工作流中出现好多次, 那我需要拷贝它好几次, 工作流文档会非常庞大.
    而 plantUML 这样的语言, 用来表达流程图很不错, 但它太重了, 定义行为的元素就有十几种, 无法做到最低成本的快速解析.

## 常见的业务流程和分析
- 常见的注册流程
```ditaa {cmd=true args=["-E"]}
        +--------------------+     +------------+  +---------------+  +------------+
 start->| sendValidationCode +-+->>| verifyCode +->| createAccount +->| sendNotify +->end
        +----------+---------+ |   +------------+  +---------------+  +------------+
                   |           |
                   +----<<-----+
```
- 复杂的注册流程
```ditaa {cmd=true args=["-E"]}
       +----------------------+     +----------------------+
start->| create guest account +-+->>| remove guest account +--------------------------->---------------------------+
       +----------------------+ |   +----------------------+                                                       |
                                |                                                                                  |
                                |   +--------------------+     +------------+    +---------------+  +------------+ |
                                +->>| sendValidationCode +-+->>| verifyCode +-+->| createAccount +->| sendNotify +-+->end
                                |   +---------+----------+ |   +------------+ |  +---------------+  +------------+
                                |             |            |                  ^
                                |             +------<<----+                  |
                                |   +------------------+  +-------------------+----------+
                                +->>| OAuthAccessToken +->| getUserInfoFormSocialNetwork |
                                    +------------------+  +------------------------------+
```
- 审批流程
```ditaa {cmd=true args=["-E"]}
         +----------------+     +----------------------+     +------------------+  
 start-->| create request +-+->>| team leader approval +-+->>| manager approval +-+-> end
         +----------------+ |   +-----------+----------+ |   +------------------+ |
                            |                            |       +----------+     |
                            +----------------------------+----->>| negative +--->-+
                                                                 +----------+
```
- 投票流程
```ditaa {cmd=true args=["-E"]}
                          +---------------+
        +-------------+   | vote by user A+-+      +----------+
start-->| create vote +->>+-+-------------+B+-+ ->>| count... +->end
        +-------------+     +-+-------------+C|    +----------+
                              +---------------+
```
- 订单和支付流程
```ditaa {cmd=true args=["-E"]}
                            /-=------+
                            | client |<----------------------------------=------------------------+
                            +---+----/                                                            |
              1. commit order   |   2. payment (3rd payment method)                               |
              +---------=-------+-<-=----+                                                        |
              |                          |                                                        |
              v                          v                                                        |
       +--------------+   +----------------------------+     +-----------------------------+      |
start->| create order +->>| request charge certificate +-+->>| check result & update order +->end |
       +--------------+   +----------------------------+ |   +-----------------------------+      |
(check & lock items, amount)           |   ^             |             ^                          |
                                       :   |             |             |                          |
                                       |   +-------------+             |                          |
                                       +---------=--------+------------+--------------------------+
                                       charge certificate |      payment results
                                                          v
                                               /-=--------------------+
                                               | 3rd payment platform |
                                               +----------------------/
```

## 对处理流程的抽象概括
包括但不限于(随时可以补充或修改)以下几种:
1. 瀑布流程 `waterfall`  
   A -> B  (串行, B 期待 A 的结果)
   当 A 执行结束后, 可以以主动或被动的方式调用 B 操作;
   任何一个工作流都是一个 `waterfall` 流程;
2. *串行流程 `series`  
   不关心上一个操作的结果, 用于优化分配工作的方式;
3. 并行流程 `parallel` (A -> [B, C] -> D)  
   B 和 C, 全部通过;
4. 分支流程 `race` (A \ B)  
   A 和 B 可以同时被调用, 但只能有一个能通过, 其它操作的结果将被丢弃;
   例如注册流程, 如有两种或以上的认证方式(phone number & OAuth), 客户可以同时尝试这两种方式, 但只有一个会成功;
   默认的分支流程都是可并行的(不锁定其他操作);
5. 有限分支流程 A \ B  
   A 和 B 同时只能有一个被调用
   A 被调用时, B 操作将不能执行
   有限分支只能主动调用, 不能自动执行
6. 并行重复流程  A{n}  
   重复执行 A 操作, 成功 n 次后流转
